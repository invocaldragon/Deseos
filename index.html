<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MVP - Invocaci√≥n M√≠stica</title>

    <meta property="og:title" content="Shenlong ‚Ä¢ Concedeme mi deseo" />
    <meta property="og:description" content="Re√∫ne las 7 esferas y hazlo realidad." />
    <meta property="og:image" content="https://invocaldragon.github.io/Shenlong/esfera4.png" />
    <meta property="og:url" content="https://invocaldragon.github.io/Shenlong" />
    <meta property="og:type" content="website" />
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Shenlong ‚Ä¢ Concedeme mi deseo">
    <meta name="twitter:description" content="Re√∫ne las 7 esferas y hazlo realidad.">
    <meta name="twitter:image" content="https://invocaldragon.github.io/Shenlong/esfera4.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QXXD7B7STE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'G-QXXD7B7STE');
    </script>

    <style>

#continueToFormButton {
    display: none;
}
        
/* Import Custom Font */
@font-face {
    font-family: 'CinzelDecorative-Bold'; /* Choose a name for your font */
    src: url('CinzelDecorative-Bold.ttf') format('truetype'); /* Specify the path to your font file and its format */
    font-weight: normal;
    font-style: normal;
}

/* General Styles */
body, html {
    font-family: 'CinzelDecorative-Bold', cursive;
    line-height: 1.6; /* Increased general line height for better readability */
    background: #000;
    color: #fff;
    overflow-x: hidden; /* Prevent horizontal scroll from animations */
}

/* Base element styles */
h2 { color: #ffcc00; }
h3 { color: #00ff88; font-size: 18px; margin-bottom: 10px; }
h4 { color: #00ff88; font-size: 18px; margin-bottom: 10px; }
h5 { color: #ffffff; font-size: 18px; margin-bottom: 10px; }
h6 { color: #CDA74B; font-size: 18px; margin-bottom: 0px; margin-top: 10px;  }    
h7 { color: #0be803; font-size: 16px; margin-bottom: 5px; margin-top: 20px; }            
p { color: #fff; }

/* Form Elements */
input[type="text"], select, textarea {
    font-family: 'Poppins', sans-serif;
    line-height: 1.6;
    padding: 10px 10px;
    width: 90%;
    border-radius: 6px;
    margin-top: 10px;
    font-size: 16px;
    border: 1px solid #00ff88;
    background-color: #0a0a0a;
    color: #fff;
}
textarea::placeholder, input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

/* Buttons */
button {
    background: linear-gradient(135deg, #00ff88, #006644);
    border: none;
    color: #fff;
    padding: 10px 10px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    transition: 0.3s ease;
    font-family: 'CinzelDecorative-Bold', cursive;
    margin-top: 15px;
    margin-bottom: 10px;
    min-height: 45px;
}

button:hover {
    background: linear-gradient(135deg, #00ffcc, #004422);
    transform: scale(1.05);
    box-shadow: 0 0 10px #00ffcc;
}

button2 {
    background: linear-gradient(135deg, #CDA74B, #826A34);
    border: none;
    color: #fff;
    padding: 10px 10px;
    font-size: 16px;
    cursor: pointer;
    border-radius: 6px;
    transition: 0.3s ease;
    font-family: 'CinzelDecorative-Bold', cursive;
    margin-top: 50px;
    margin-bottom: 20px;
    min-height: 45px;
}

button2:hover {
    background: linear-gradient(135deg, #826A34, #CDA74B);
    transform: scale(1.05);
    box-shadow: 0 0 10px gold;
}
        
/* Layout Containers */
.container {
    text-align: center;
    max-width: 100%;
    padding: 20px;
    margin-top: 20px;  
    margin-bottom: 20px;
}

.container--game-section {
    background-color: transparent;
    box-shadow: none;
}

.legal-notice {
    font-size: 10px;
    color: #aaa;
    font-family: 'Poppins', sans-serif;
    font-weight: 300;
    margin: 40px auto;
    max-width: 600px;
    text-align: left;
}

/* Game Canvas */
canvas {
    width: 100%;
    height: 450px;
    display: block;
    margin: 0 auto;
    background-color: #000;
    border: 3px solid #ff9800;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Popup Overlays */
.popup-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 999;
    display: none;
    align-items: center;
    justify-content: center;
}

.popup-container {
    animation: fadeInMagic 0.8s ease-out;
    box-shadow: 0 0 20px #00ff88aa;
    background: #111;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    margin: 0 auto;
    position: relative; /* <-- A√ëADIDO: Permite posicionar el spinner dentro */
}

/* ESTILOS A√ëADIDOS: Inicio de los estilos para el Spinner de Carga */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(17, 17, 17, 0.85); /* Fondo oscuro para atenuar el contenido */
    z-index: 10;
    display: none; /* Oculto por defecto */
    justify-content: center;
    align-items: center;
    border-radius: 12px; /* Coincide con el radio del popup */
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3); /* Color base del c√≠rculo */
    border-top-color: #00ff88; /* Color de la parte que gira */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

        
.popup-container2 {
    animation: fadeInMagic 0.8s ease-out;
    box-shadow: 0 0 20px gold;
    background: #111;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    margin: 0 auto;
}
        
/* Animations */
@keyframes fadeInMagic {
    0% {opacity: 0; transform: scale(0.9); filter: blur(5px);}
    100% {opacity: 1; transform: scale(1); filter: blur(0);}
}

/* Specific Image Styles & Animations */
.qr-yape {
    max-width: 250px;
    margin: 20px auto;
    display: block;
    border-radius: 20px;
    margin-bottom: 30px;
    animation: resplandor-yape 3s infinite ease-in-out;
    filter: drop-shadow(0 0 10px #CDA74B) drop-shadow(0 0 20px #826A34);
}

@keyframes resplandor-yape {
    0%, 100% {
        filter: drop-shadow(0 0 10px #CDA74B) drop-shadow(0 0 20px #826A34);
    }
    50% {
        filter: drop-shadow(0 0 20px #826A34) drop-shadow(0 0 35px #CDA74B);
    }
}

.shenlong-static {
    display: block;
    max-width: 80%;
    height: auto;
    margin: 30px auto 0 auto; /* auto a izquierda y derecha la centra */
    animation: aparecer 2s ease-out forwards, 
               resplandor-mistico 3s infinite ease-in-out, 
               flotar 4s ease-in-out infinite;
}

      
@keyframes resplandor-mistico {
    0%, 100% {
        filter: drop-shadow(0 0 15px #00ffcc) drop-shadow(0 0 25px #00ffcc);
    }
    50% {
        filter: drop-shadow(0 0 25px #00ffcc) drop-shadow(0 0 40px #00ffcc);
    }
}

.shenlong-gif {
    display: block;
    margin: 20px auto;
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 0 20px #00ffcc;
    animation: aparecer 2s ease-out forwards, resplandor-mistico 1s infinite ease-in-out;
}

/* Specific Button Styles */
.button--final-action {
    margin-bottom: 10px;
    width: 90%;
    max-width: 300px;
}

/* Other Specific Styles */
.title--mystic {
    color: #0be803;
    text-align: center;
}

.instructions { }

.countdown {
    font-size: 24px;
    font-weight: bold;
    margin-top: 10px;
}

.shenlong-phrase {
    font-size: 20px;
    margin: 20px 0;
}

.donation-section {
    margin-top: 20px;
}

.donation-text {
    font-size: 0.8em;
}

/* Keyframes */
@keyframes aparecer {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes flotar {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-10px);
    }
}

.speed-selection-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
  flex-wrap: nowrap;
  margin-bottom: 20px;
  text-align: center;
}

  .speed-text,
  .speed-controls {
    flex: 1 1 100%;
  }

.speed-controls label {
  display: flex;
  align-items: center;
  gap: 10px;
}

#barra-top-supremos {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(90deg, #086d03, #0be803);
  color: white;
  text-align: center;
  padding: 12px;
  font-size: 12px;
  font-weight: regular;
  z-index: 9999;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
  transition: background 0.3s;
}

#barra-top-supremos:hover {
  background: linear-gradient(90deg, #0be803, #086d03);
}

.linea-divisoria {
  border: none;
  border-top: 1px solid #0be803;
  margin: 1.5rem auto; /* Centrada horizontalmente */
  width: 80%;
  opacity: 0.8;
}


.top-deseos-lista {
  list-style: none;
  padding: 0;
  margin: 0;
}

.top-deseos-lista li {
  margin-bottom: 12px;
  font-size: 16px;
  color: #fff;
  position: relative;
  padding-left: 10px;
}

.mistico-nombre {
  display: block;
  font-size: 13px;
  color: #00ffcc;
  margin-top: 4px;
  margin-left: 10px;
}

.nota-mistica {
  font-size: 13px;
  color: #aaa;
  margin-top: 15px;
  text-align: center;
}

.deseo {
  background: linear-gradient(135deg, #1e1e1e, #2e2e2e);
  border: 1px solid #444;
  border-radius: 10px;
  padding: 15px;
  margin: 10px auto;
  max-width: 500px;
  box-shadow: 0 0 10px #00ff88;
  transition: all 0.3s ease-in-out;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.deseo {
  display: flex;
  align-items: center;
  gap: 15px;
  justify-content: flex-start;
  padding: 15px;
}

.texto-nombre {
  text-align: left;
  max-width: 80%;
}

.nombre {
  font-size: 13px;
  color: #ffcc00;
}

.texto {
  font-size: 15px;
}

.radio-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

.speed-controls-images {
  text-align: center;
  margin: 20px 0;
}
.speed-controls-images img {
  width: 130px;
  margin: 0 15px;
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 10px;
  transition: transform 0.3s, border-color 0.3s;
}
.speed-controls-images img:hover {
  transform: scale(1.5);
  border-color: gold;
}

  .dragon-ball-divider {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 40px; /* üëà Espacio debajo de las esferas */
  }

  .dragon-ball {
    width: 40px;
    margin: 0 2px;
    animation: spin 20s linear infinite;
    transform-origin: center center;
  }

  @keyframes spin {
    0%   { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 600px) {
    .dragon-ball {
      width: 30px;
    }
  }


        
</style>
</head>
<body>

<h2 class="title--mystic">Tu aporte voluntario</h2>

<img src="https://raw.githubusercontent.com/invocaldragon/shenlong/PRUEBAS/sheng1.png" alt="Invocaci√≥n Shenlong" class="shenlong-static">
  
<h2 class="title--mystic">Cumplir√° tu deseo</h2>
  
    <div class="legal-notice">
        <strong>Aviso Legal:</strong>
        <p>
            ‚Ä¢ Esta plataforma es solo para entretenimiento.<br>
            ‚Ä¢ El deseo solicitado es una intenci√≥n personal dentro del ritual.<br>
            ‚Ä¢ Las contribuciones son voluntarias y no reembolsables.<br>
            ‚Ä¢ Participar implica aceptar estos t√©rminos.<br>
            ‚Ä¢ Personajes y referencias son ilustrativos, no afiliados a marcas oficiales.<br>
            ¬© 2025 Invoca al drag√≥n. Todos los derechos reservados. üêâ
        </p>
    </div>

    <div id="popup-wish" class="popup-overlay">
        <div class="popup-container">
            <img src="Invocacion2.gif" alt="Invocaci√≥n Shenlong" class="shenlong-gif">
            <h4>Mortal, p√≠deme tu deseo<br>Tengo prisa...</h4>
            <div id="countdown">60</div>

            <input type="text" id="userAliasInput" placeholder="Tu nombre (opcional)" aria-label="Escribe tu alias m√≠stico">
            
            <textarea id="userWishInput" class="campo-deseo" rows="2" placeholder="Tu deseo..." aria-label="Escribe tu deseo"></textarea>
            
            <button id="submitWishButton">Pedir Deseo</button>
        </div>
    </div>
  
  

    <div id="popup-shenlong-reply" class="popup-overlay">
        <div class="popup-container">
            <img src="sheng1.png" alt="Invocaci√≥n Shenlong" class="shenlong-static">
            <h3>Ese ser√° un deseo muy f√°cil de realizar...</h3>
            <p id="fullPhraseText" class="shenlong-phrase"></p>

            <p style="font-size: 14px; margin-top: -5px;">El drag√≥n nunca olvida a quien invoca con el coraz√≥n firme</p>
            
            <div class="dragon-ball-divider">
              <img src="esfera1.png" class="dragon-ball" alt="Esfera 1">
              <img src="esfera2.png" class="dragon-ball" alt="Esfera 2">
              <img src="esfera3.png" class="dragon-ball" alt="Esfera 3">
              <img src="esfera4.png" class="dragon-ball" alt="Esfera 4">
              <img src="esfera5.png" class="dragon-ball" alt="Esfera 5">
              <img src="esfera6.png" class="dragon-ball" alt="Esfera 6">
              <img src="esfera7.png" class="dragon-ball" alt="Esfera 7">
            </div>
                
            <button id="SubirDeseoButton">Continuar</button>
            <button id="continueToFormButton">üôè No</button>
        </div>
    </div>

    <div id="popup-final" class="popup-overlay">
        <div class="popup-container">
            <h3 class="final-message-title">üèÜ Top Semanal de Deseos üèÜ</h3>
              <ul class="top-deseos-lista">
                <li><strong>ü•á</strong> Conseguir mi primer depa sola<span class="mistico-nombre"> ‚Äì Tania</span><span class="contador-votos">üåü 173 votos</span></li>
                <li><strong>ü•à</strong> Salir de deudas este a√±o<span class="mistico-nombre"> ‚Äì Javi</span><span class="contador-votos">üåü 164 votos</span></li>
                <li><strong>ü•â</strong> Ser parte de algo bonito<span class="mistico-nombre"> ‚Äì Gabo</span><span class="contador-votos">üåü 157 votos</span></li>
              </ul>
            <p class="nota-mistica">Este ranking se actualiza todos los lunes<br>¬°Vota por tu favorito!</p>
            <button id="VotarDeseoButton" class="button--final-action">üåü Votar</button>
            <button id="DeseoSupremoButton" class="button--final-action" style="display: none;">üèÜ Top Deseos Supremos</button>
            <button id="shareWhatsappButton" class="button--final-action" style="display: none;">üì≤ Compartir</button>
            <button id="invokeAgainButton" class="button--final-action" style="display: none;">üîÅ Volver a invocar</button>
            <button id="Regresar4Button" class="button--final-action">üîÆ Mi deseo</button>

        </div>
    </div>

    <div id="popup-DeseoSupremo" class="popup-overlay">
        <div class="popup-container">
            <h3 class="final-message-title">Vota por el Deseo Supremo de la Semana üèÜ</h3>
            <img src="TopDeseos.png" alt="QR de Yape" class="qr-yape">
            <button id="VotarDeseoButton" class="button--final-action">Votar por un deseo</button>
            <button id="SubirDeseo2Button" class="button--final-action">Subir mi Deseo Supremo</button>
            <button id="RegresarButton" class="button--final-action">Regresar</button>

        </div>
    </div>

    <div id="popup-VotarDeseo" class="popup-overlay">
        <div class="popup-container">
            <div id="loadingSpinner" class="loading-overlay">
                <div class="spinner"></div>
            </div>    
            <h3 class="final-message-title">¬° Votar por un Deseo Supremo !</h3>
              <div id="countdown2">Cambiando en: 15 segundos</div>
              <form id="votacionDeseos">
                <div id="contenedor-deseos"></div>
                <button type="submit" id="votarBtn">Votar por este deseo</button>
              </form>
            <button id="Regresar2Button" class="button--final-action" style="display: none;">Regresar</button>

        </div>
    </div>


    <div id="popup-SubirDeseo" class="popup-overlay">
        <div class="popup-container2">
            <h7 id="codigoSupremoDisplay" class="final-message-title"></h7>
            <h6 class="final-message-title">¬° Shenlong concede deseos antes a quien invoca con m√°s fuerza !</h6>
            <div class="donation-section">
                <p class="donation-text" style="font-family: 'Poppins', sans-serif; font-size: 13px;">Usa Yape y escribe tu C√ìDIGO SUPREMO en el mensaje<br>Dale valor con tu aporte voluntario</p>
                <img src="QR.jpg" alt="QR de Yape" class="qr-yape">
            </div>
            <button2 id="Regresar3Button" class="button--final-action">Continuar</button2>

        </div>
    </div>


    <script>

// Constants
const SPHERE_RADIUS = 30;
const MARGIN = 2;
const GOOGLE_SHEETS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqFM_rdkLidWzz2sf71eAJxh3KQWNUOm7kNgjCGx0QgFtfXTco0P2WO5JjCLajz5Wz/exec';

// DOM Elements
const gameCanvas = document.getElementById("gameCanvas");
const ctx = gameCanvas.getContext("2d");
const instructionsElement = document.getElementById("instructions");
const countdownElement = document.getElementById("countdown");
const userWishInput = document.getElementById("userWishInput");
const userAliasInput = document.getElementById("userAliasInput"); // A√ëADIDO: Referencia al campo de alias
const fullPhraseText = document.getElementById("fullPhraseText");

// Popups
const popupWish = document.getElementById("popup-wish");
const popupShenlongReply = document.getElementById("popup-shenlong-reply");
const popupFinal = document.getElementById("popup-final");
const popupDeseoSupremo = document.getElementById("popup-DeseoSupremo");
const popupVotarDeseo = document.getElementById("popup-VotarDeseo");
const popupSubirDeseo = document.getElementById("popup-SubirDeseo");

// Buttons
const submitWishButton = document.getElementById("submitWishButton");
const continueToFormButton = document.getElementById("continueToFormButton");
const shareWhatsappButton = document.getElementById("shareWhatsappButton");
const invokeAgainButton = document.getElementById("invokeAgainButton");
const DeseoSupremoButton = document.getElementById("DeseoSupremoButton");
const VotarDeseoButton = document.getElementById("VotarDeseoButton");
const SubirDeseoButton = document.getElementById("SubirDeseoButton");
const RegresarButton = document.getElementById("RegresarButton");
const Regresar2Button = document.getElementById("Regresar2Button");
const Regresar3Button = document.getElementById("Regresar3Button");
const Regresar4Button = document.getElementById("Regresar4Button");

// Audio
const sphere7Audio = new Audio('quienmehallamado.mp3');
const sphere8Audio = new Audio('deseofacil.mp3');

// Game State Variables
let speedMultiplier = 2.5;
let currentStep = 1;
let spheres = [];
let countdownInterval;
let userWish = "";
let userAlias = "";
let codigoSupremoGenerado = ""; // NUEVO: Variable para guardar el c√≥digo

// --- NUEVO: Funci√≥n para generar el C√≥digo Supremo ---
function generarCodigoSupremo() {
    const prefijo = 'SH';
    // Genera un n√∫mero aleatorio entre 100 y 999
    const numero = Math.floor(Math.random() * 900) + 100;
    return `${prefijo}-${numero}`;
}
        
// Image Preloading
const images = [];
for (let i = 1; i <= 7; i++) {
    const img = new Image();
    img.src = `esfera${i}.png`;
    images.push(img);
}

// --- DragonBall Class ---
class DragonBall {
    constructor(x, y, number) {
        this.x = x;
        this.y = y;
        const angle = Math.random() * 2 * Math.PI;
        this.vx = Math.cos(angle);
        this.vy = Math.sin(angle);
        this.number = number;
        this.radius = SPHERE_RADIUS;
        this.found = false;
        this.image = images[number - 1];
    }

    update() {
        if (this.found) return;

        this.x += this.vx * speedMultiplier;
        this.y += this.vy * speedMultiplier;

        // Boundary collision detection
        const leftLimit = this.radius + MARGIN;
        const rightLimit = gameCanvas.width - this.radius - MARGIN;
        const topLimit = this.radius + MARGIN;
        const bottomLimit = gameCanvas.height - this.radius - MARGIN;

        if (this.x < leftLimit) { this.x = leftLimit; this.vx *= -1; }
        if (this.x > rightLimit) { this.x = rightLimit; this.vx *= -1; }
        if (this.y < topLimit) { this.y = topLimit; this.vy *= -1; }
        if (this.y > bottomLimit) { this.y = bottomLimit; this.vy *= -1; }
    }

    draw() {
        if (this.found) {
            ctx.save();
            ctx.shadowColor = '#ffff00';
            ctx.shadowBlur = 30;
        }
        ctx.drawImage(this.image, this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
        if (this.found) {
            ctx.restore();
        }
    }

    isInside(mx, my) {
        return Math.hypot(mx - this.x, my - this.y) <= this.radius;
    }
}

// --- Game Functions ---
function generateSpheres() {
    const newSpheres = [];
    for (let i = 1; i <= 7; i++) {
        let valid = false, x, y;
        while (!valid) {
            x = Math.random() * (gameCanvas.width - 2 * (SPHERE_RADIUS + MARGIN)) + (SPHERE_RADIUS + MARGIN);
            y = Math.random() * (gameCanvas.height - 2 * (SPHERE_RADIUS + MARGIN)) + (SPHERE_RADIUS + MARGIN);
            valid = true;
            for (const s of newSpheres) {
                if (Math.hypot(s.x - x, s.y - y) < SPHERE_RADIUS * 2 + 4) {
                    valid = false;
                    break;
                }
            }
        }
        newSpheres.push(new DragonBall(x, y, i));
    }
    return newSpheres;
}

function drawAll() {
    ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
    for (const s of spheres) {
        s.update();
        s.draw();
    }
    requestAnimationFrame(drawAll);
}

function resetGame() {
    currentStep = 1;
    spheres = generateSpheres();
    instructionsElement.textContent = "Que poder te representa...";
}

function setSpeed(factor) {
    speedMultiplier = factor;
    for (const s of spheres) {
        if (!s.found) {
            const angle = Math.atan2(s.vy, s.vx);
            s.vx = Math.cos(angle);
            s.vy = Math.sin(angle);
        }
    }
}

// --- Popup Management ---
function openPopup(popupElement) {
    [popupWish, popupShenlongReply, popupFinal, popupDeseoSupremo, popupVotarDeseo, popupSubirDeseo].forEach(p => p.style.display = 'none');
    popupElement.style.display = 'flex';
}

function closePopup(popupElement) {
    popupElement.style.display = 'none';
}

// --- Data Submission ---
async function sendToGoogleSheets(data) {
    const params = new URLSearchParams(data).toString();
    try {
        await fetch(GOOGLE_SHEETS_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params
        });
        console.log("Data sent to Google Sheets successfully (no-cors mode).");
    } catch (error) {
        console.error("Error sending data to Google Sheets:", error);
    }
}

// --- Event Handlers ---

// Game Canvas Click
gameCanvas.addEventListener("click", e => {
    const rect = gameCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    for (const s of spheres) {
        if (!s.found && s.isInside(mx, my)) {
            s.found = true;
            s.vx = 0; 
            s.vy = 0;

            // Mostrar cu√°ntas faltan
            const restantes = spheres.filter(s => !s.found).length;
            if (restantes > 0) {
                instructionsElement.textContent = `Faltan ${restantes} esfera${restantes === 1 ? '' : 's'} y el deseo ser√° tuyo`;
            } else {
                instructionsElement.textContent = "¬°Has reunido todas las esferas del drag√≥n!";
                sphere7Audio.play().catch(err => console.error("Error playing audio:", err));
                openPopup(popupWish);

                let countdownValue = 60;
                countdownElement.innerText = countdownValue;
                countdownInterval = setInterval(() => {
                    countdownValue--;
                    countdownElement.innerText = countdownValue;
                    if (countdownValue <= 0) {
                        clearInterval(countdownInterval);
                        closePopup(popupWish);
                        location.reload();
                    }
                }, 1000);
            }
            break;
        }
    }
});


    // MODIFICADO: El listener del bot√≥n para pedir el deseo ahora genera y guarda el c√≥digo
    document.getElementById("submitWishButton").addEventListener('click', () => {
        const alias = userAliasInput.value.trim() || "An√≥nimo";
        const wish = userWishInput.value.trim();

        if (!wish) { alert("Escribe tu deseo."); return; }

        userAlias = alias;
        userWish = wish;
        
        // NUEVO: Generamos y guardamos el c√≥digo en este momento
        codigoSupremoGenerado = generarCodigoSupremo();

        // MODIFICADO: Enviamos el nuevo c√≥digo a Google Sheets
        sendToGoogleSheets({ 
            alias: userAlias, 
            deseo: userWish, 
            codigo: codigoSupremoGenerado // Enviamos el c√≥digo
        });


    closePopup(popupWish);
    clearInterval(countdownInterval);
    sphere7Audio.pause();
    sphere8Audio.play().catch(err => console.error("Error playing audio:", err));
    fullPhraseText.innerHTML = `<em>‚Äú${userWish}‚Äù</em>`;
    openPopup(popupShenlongReply);
});

// Continue to Form Button -> Now goes to Final Popup
continueToFormButton.addEventListener('click', () => {
    closePopup(popupShenlongReply);
    openPopup(popupFinal);
});

// Share on WhatsApp Button
shareWhatsappButton.addEventListener('click', () => {
    const mensaje = "*Acabo de pedirle un deseo a Shenlong üêâüëá*\nhttps://invocaldragon.github.io/Shenlong\n\n*¬°Apres√∫rate!*\nQuiz√° te comparta un poco de mi suerteüçÄ";
    const whatsappURL = "https://wa.me/?text=" + encodeURIComponent(mensaje);
    window.open(whatsappURL, "_blank");
});

// Invoke Again Button
invokeAgainButton.addEventListener('click', () => {
    userWish = ""; 
    userAlias = ""; // A√ëADIDO: Resetea el alias
    userWishInput.value = "";
    userAliasInput.value = ""; // A√ëADIDO: Limpia el campo de alias
    
    [popupWish, popupShenlongReply, popupFinal, popupDeseoSupremo, popupVotarDeseo, popupSubirDeseo].forEach(p => p.style.display = 'none');
    location.reload();
});

function resizeCanvas() {
    const rect = gameCanvas.getBoundingClientRect();
    gameCanvas.width = rect.width;
    gameCanvas.height = rect.height;
}

resizeCanvas();
window.addEventListener("resize", resizeCanvas);

DeseoSupremoButton.addEventListener("click", () => {
    closePopup(popupFinal);
    openPopup(popupDeseoSupremo);
});

VotarDeseoButton.addEventListener("click", () => {
    closePopup(popupDeseoSupremo);
    openPopup(popupVotarDeseo);
});
    // MODIFICADO: Ahora mostramos el c√≥digo generado antes de abrir el popup
    document.getElementById("SubirDeseoButton").addEventListener('click', () => {
        // NUEVO: Asignamos el c√≥digo generado al elemento HTML
        document.getElementById('codigoSupremoDisplay').textContent = `C√≥digo Supremo: ${codigoSupremoGenerado}`;
        openPopup(popupSubirDeseo);
    });
RegresarButton.addEventListener("click", () => {
    closePopup(popupDeseoSupremo);
    openPopup(popupFinal);
});

Regresar2Button.addEventListener("click", () => {
    closePopup(popupVotarDeseo);
    openPopup(popupFinal);
});

Regresar3Button.addEventListener("click", () => {
    closePopup(popupSubirDeseo);
    openPopup(popupFinal);
});
Regresar4Button.addEventListener("click", () => {
    if (!userWish || userWish.trim() === "") {
        location.reload();
    } else {
        closePopup(popupFinal);
        openPopup(popupShenlongReply);
    }
});

document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") {
        const visiblePopup = [popupWish, popupShenlongReply, popupFinal, popupDeseoSupremo, popupVotarDeseo, popupSubirDeseo].find(p => p.style.display === 'flex');
        if (visiblePopup) {
            closePopup(visiblePopup);
            clearInterval(countdownInterval);
        }
    }
});

Promise.all(images.map(img => new Promise(res => img.onload = res)))
    .then(startGame)
    .catch(err => console.error("Failed to load one or more sphere images:", err));

function startGame() {
    resetGame();
    drawAll();
}

function verTopDeseos() {
  const allPopups = document.querySelectorAll('.popup-overlay');
  allPopups.forEach(popup => {
    popup.style.display = 'none';
  });
  const popupFinal = document.getElementById('popup-final');
  if (popupFinal) {
    popupFinal.style.display = 'flex';
  }
}

// --- L√≥gica para la Votaci√≥n de Deseos Supremos ---

// Referencias a los elementos del DOM para la votaci√≥n
const contenedorDeseos = document.getElementById('contenedor-deseos');
const countdownVotacion = document.getElementById('countdown2');
const formVotacion = document.getElementById('votacionDeseos');

let intervaloVotacion;
let listaCompletaDeseos = []; // Almacenar√° los deseos cargados desde la hoja

/**
 * Funci√≥n principal para cargar los deseos desde Google Sheets.
 */
async function cargarDeseosSupremos() {
  try {
    // Hacemos una petici√≥n GET a la URL de nuestro script.
    // fetch() por defecto usa el m√©todo GET, as√≠ que activar√° la funci√≥n doGet.
    const response = await fetch(GOOGLE_SHEETS_SCRIPT_URL);
    if (!response.ok) {
      throw new Error('Error al conectar con el Or√°culo de los Deseos. C√≥digo: ' + response.status);
    }
    
    const deseos = await response.json();
    
    if (deseos.result === 'error') {
        throw new Error(deseos.error);
    }

    listaCompletaDeseos = deseos; // Guardamos la lista completa
    
    // Si se cargan deseos, iniciamos el proceso de votaci√≥n.
    if (listaCompletaDeseos.length > 0) {
      iniciarCicloDeVotacion();
    } else {
      contenedorDeseos.innerHTML = "<p>El Or√°culo est√° en silencio... No hay deseos supremos para votar en este momento.</p>";
    }

  } catch (error) {
    console.error("Error al cargar los Deseos Supremos:", error);
    contenedorDeseos.innerHTML = `<p>Hubo un problema al contactar al Or√°culo. Int√©ntalo de nuevo m√°s tarde.</p>`;
  }
}

/**
 * Inicia y reinicia el temporizador y la muestra de deseos.
 */
function iniciarCicloDeVotacion() {
  mostrarNuevosDeseos(); // Muestra el primer set de deseos
  
  let tiempo = 15;
  countdownVotacion.textContent = `Cambiando en: ${tiempo} segundos`;

  clearInterval(intervaloVotacion); // Limpia cualquier temporizador anterior
  intervaloVotacion = setInterval(() => {
    tiempo--;
    countdownVotacion.textContent = `Cambiando en: ${tiempo} segundos`;
    if (tiempo <= 0) {
      tiempo = 15; // Reinicia el contador
      mostrarNuevosDeseos(); // Muestra nuevos deseos
    }
  }, 1000);
}

/**
 * Selecciona 3 deseos aleatorios de la lista completa y los muestra.
 */
function mostrarNuevosDeseos() {
  const copiaDeseos = [...listaCompletaDeseos];
  const elegidos = [];

  // Elige hasta 3 deseos aleatorios
  const cantidadAMostrar = Math.min(3, copiaDeseos.length);

  for (let i = 0; i < cantidadAMostrar; i++) {
    const index = Math.floor(Math.random() * copiaDeseos.length);
    elegidos.push(copiaDeseos.splice(index, 1)[0]);
  }

  // Genera el HTML para los deseos elegidos
  if (elegidos.length > 0) {
        contenedorDeseos.innerHTML = elegidos.map(d =>
          `<label class="deseo">
            <div class="radio-container">
              <input type="radio" name="deseoSeleccionado" value="${d.id}">
            </div>
            <div class="texto-nombre">
              <div class="texto">‚Äú${d.texto}‚Äù</div>
              <div class="nombre">‚Äì ${d.nombre}</div>
              <div class="votos" style="font-size: 12px; color: #ccc;">üåü Votos: ${d.votos || 0}</div>
            </div>
          </label>`
        ).join('');

  } else if (listaCompletaDeseos.length > 0) {
      // Si hay deseos pero no se pudieron elegir (caso raro)
      contenedorDeseos.innerHTML = "<p>Mezclando las energ√≠as de los deseos...</p>";
  }
}

// Evento para manejar el env√≠o del voto
formVotacion.addEventListener('submit', function (e) {
  e.preventDefault();
  const seleccionado = formVotacion.deseoSeleccionado?.value;

  // A√ëADIDO: Obtenemos la referencia al spinner
  const loadingSpinner = document.getElementById('loadingSpinner');

  if (!seleccionado) {
    alert('Por favor, selecciona un deseo antes de votar.');
    return;
  }

  // A√ëADIDO: Mostramos el spinner
  loadingSpinner.style.display = 'flex';
    
  const scriptURLVoto = 'https://script.google.com/macros/s/AKfycbyqFM_rdkLidWzz2sf71eAJxh3KQWNUOm7kNgjCGx0QgFtfXTco0P2WO5JjCLajz5Wz/exec';
  const data = new FormData();
  data.append('desireId', seleccionado);

  fetch(scriptURLVoto, {
    method: 'POST',
    body: data
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`Error de red: ${response.status} ${response.statusText}`);
    }
    return response.json();
  })
  .then(result => {
    if (result.result === 'success') {
      // 1. Mensaje opcional (si quieres dejarlo)
      alert(`üåü Has votado por el deseo #${seleccionado}. ¬°Gracias por tu energ√≠a!`);

      // 2. Cierra el popup actual (votaci√≥n)
      closePopup(popupVotarDeseo);

      // 3. Abre el popup final
      openPopup(popupFinal);

      // 4. Opcional: recarga los deseos por si quieres que se actualicen los votos
      cargarDeseosSupremos();
    } else {
      alert(`‚ùå Hubo un error al registrar tu voto: ${result.error}`);
      console.error('Error del servidor:', result.error);
    }
  })
  .catch(error => {
    console.error('Error al enviar el voto:', error);
    alert('‚ö†Ô∏è Hubo un problema al conectar con el servicio de votaci√≥n.');
  })
  .finally(() => {
    // A√ëADIDO: Ocultamos el spinner sin importar el resultado
    loadingSpinner.style.display = 'none';
  });
});
        
        
        
// --- INICIALIZACI√ìN ---
// En lugar de llamar a las funciones directamente, llamamos a la funci√≥n que carga los datos.
cargarDeseosSupremos();
        
</script>
</body>
</html>
